# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

domet is a React scroll-spy hook library. The monorepo contains:
- `packages/domet`: The npm package (React hook for scroll tracking)
- `website`: Next.js documentation site using Fumadocs

## Commands

### Root (Turborepo)
```bash
npm run dev          # Run all dev servers
npm run build        # Build all packages
npm run lint         # Lint all packages
npm run test         # Run all tests
```

### Package: domet
```bash
cd packages/domet
npm run build        # Compile TypeScript
npm run dev          # Watch mode
npm test             # Run Vitest tests
npm test -- --watch  # Watch mode
npm test -- useDomet.test.tsx  # Single test file
```

### Website
```bash
cd website
npm run dev          # Next.js dev with Turbopack
npm run build        # Production build
```

## Architecture

### Hook Algorithm (`useDomet.ts`)

The hook uses a **scoring system** to determine the active section:
1. **Visibility score**: Sections with >60% visibility get bonus points
2. **Trigger line proximity**: Sections crossing the trigger line (offset from top) get priority
3. **Hysteresis**: A 150-point margin prevents rapid switching between sections
4. **Edge cases**: Top/bottom of page forces first/last section active

Key constants:
- `VISIBILITY_THRESHOLD = 0.6` (60% visibility required for high score)
- `HYSTERESIS_SCORE_MARGIN = 150` (score difference needed to switch sections)

### Performance

- `requestAnimationFrame` for smooth 60fps updates
- Throttling with configurable `debounceMs` (default 10ms)
- Refs stored in `useRef` to avoid re-renders
- `useMemo` for stable section ID arrays
- The container ref is assumed stable for the lifetime of the hook; remount the hook to change it

## Package Exports

```typescript
import { useDomet } from 'domet';
import type { DometOptions, UseDometReturn } from 'domet';
```

## Testing

Tests use Vitest with jsdom. Mock `IntersectionObserver` and `getBoundingClientRect` for scroll simulation.

## Code Style Rules

### Error and Warning Messages

All user-facing messages (console warnings, error messages, UI feedback) must follow these rules:

1. **Language**: Always in English
2. **Format**: Simple, clear, and consistent
3. **Structure**: `[context] Description.` or just `Description.`
4. **Examples**:
   - Console: `[domet] Invalid offset value: ${value}. Using default.`
   - UI: `Invalid format. Use a number (e.g. 100) or percentage (e.g. 10%).`
   - UI: `Value clamped to ±${max}px.`

**Do NOT**:
- Use French or other languages
- Use jargon or overly technical terms
- Write long sentences

## Documentation Rules

In `website/content/documentation.mdx`:

1. **API changes require documentation**: ALWAYS update docs when adding/removing/modifying API (options, return values, types, callbacks). No API change ships without doc update.

2. **Examples need descriptions**: In section `## Examples`, when adding an example with a title, always include a brief description. Never just a title alone.

3. **Line numbers in code blocks**:
   - 2 lines or less: no `showLineNumbers`
   - More than 2 lines: add `showLineNumbers`

**Example (description rule):**
```markdown
### CSS Selector for Sections
Instead of passing an array of IDs, you can use a CSS selector to automatically find sections:
```

**Example (line numbers rule):**
```markdown
≤2 lines → ```tsx
>2 lines → ```tsx showLineNumbers
```

## Auto-Generated Files (DO NOT EDIT)

The following files are auto-generated by `scripts/documentation.ts` from `website/content/documentation.mdx`:

- `README.md`
- `website/public/llms.txt`
- `packages/domet/README.md`
- `website/config/site.ts` (only `APP_NAME` and `APP_DESCRIPTION` from frontmatter)

**NEVER modify these files directly.** Edit `website/content/documentation.mdx` instead, then run the sync script.
